<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Voice AI Chatbot - Enhanced</title>
  <style>
    :root {
      --blue: #007bff;
      --red: #dc3545;
      --light-bg: #e5eaf5;
      --light-container-bg: #ffffff;
      --light-text-user: white;
      --light-text-bot: #333;
      --dark-bg: #1e1e2f;
      --dark-container-bg: #2a2a40;
      --dark-text-user: #a0c4ff;
      --dark-text-bot: #ddd;
      --error-bg: #f8d7da;
      --error-text: #721c24;
      --success-bg: #d4edda;
      --success-text: #155724;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--light-bg);
      color: #222;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    body.dark {
      background: var(--dark-bg);
      color: var(--dark-text-bot);
    }

    .chat-container {
      background: var(--light-container-bg);
      width: 100%;
      max-width: 600px;
      height: 85vh;
      max-height: 720px;
      border-radius: 12px;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.12);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      position: relative;
    }

    body.dark .chat-container {
      background: var(--dark-container-bg);
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.6);
    }

    .header {
      padding: 14px 24px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: transparent;
      user-select: none;
      gap: 10px;
    }

    .toggle-btn, #clearBtn, #pauseTTSBtn {
      background: var(--blue);
      border: none;
      color: white;
      font-weight: 600;
      border-radius: 20px;
      padding: 8px 18px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 3px 10px rgba(0, 123, 255, 0.4);
      transition: background-color 0.3s ease;
      user-select: none;
      white-space: nowrap;
    }

    .toggle-btn:hover, #clearBtn:hover, #pauseTTSBtn:hover {
      background: #0056b3;
    }

    .messages {
      flex: 1;
      padding: 20px 24px;
      overflow-y: auto;
      scroll-behavior: smooth;
      display: flex;
      flex-direction: column;
      gap: 12px;
      font-size: 15px;
      line-height: 1.5;
      background: transparent;
    }

    .message {
      max-width: 70%;
      padding: 14px 20px;
      border-radius: 20px;
      user-select: text;
      white-space: pre-wrap;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease;
      box-shadow: 0 1px 5px rgba(0,0,0,0.08);
      position: relative;
      cursor: default;
    }

    .message[data-timestamp]::after {
      content: attr(data-timestamp);
      font-size: 10px;
      opacity: 0.5;
      position: absolute;
      bottom: 4px;
      right: 12px;
      user-select: none;
    }

    .user {
      align-self: flex-end;
      background: var(--blue);
      color: var(--light-text-user);
      border-bottom-right-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,123,255,0.5);
    }

    body.dark .user {
      background: #3390ff;
      color: var(--dark-text-user);
      box-shadow: 0 2px 8px rgba(51,144,255,0.8);
    }

    .bot {
      align-self: flex-start;
      background: #f1f1f1;
      color: var(--light-text-bot);
      border-bottom-left-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    body.dark .bot {
      background: #3a3a5a;
      color: var(--dark-text-bot);
      box-shadow: 0 2px 8px rgba(0,0,0,0.7);
    }

    .typing {
      font-style: italic;
      opacity: 0.8;
      user-select: none;
    }

    .error-banner {
      background: var(--error-bg);
      color: var(--error-text);
      padding: 8px 12px;
      text-align: center;
      font-weight: 600;
      border-radius: 6px;
      margin: 10px 24px 0;
    }

    .success-banner {
      background: var(--success-bg);
      color: var(--success-text);
      padding: 8px 12px;
      text-align: center;
      font-weight: 600;
      border-radius: 6px;
      margin: 10px 24px 0;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(220,53,69,0.4);
      }
      70% {
        box-shadow: 0 0 0 15px rgba(220,53,69,0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(220,53,69,0);
      }
    }

    .form-area {
      display: flex;
      padding: 14px 24px;
      border-top: 1px solid #ddd;
      gap: 10px;
      background: transparent;
      transition: border-color 0.3s ease;
    }

    body.dark .form-area {
      border-top-color: #555;
    }

    textarea[type="text"] {
      flex: 1;
      padding: 14px 20px;
      font-size: 16px;
      border-radius: 9999px;
      border: 1.8px solid #ccc;
      outline: none;
      background: #fff;
      color: #222;
      transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
      box-shadow: inset 0 1px 4px rgba(0,0,0,0.05);
      resize: vertical;
      min-height: 44px;
      max-height: 120px;
    }

    textarea[type="text"]:focus {
      border-color: var(--blue);
      box-shadow: 0 0 10px var(--blue);
      background: #fff;
      color: #222;
    }

    body.dark textarea[type="text"] {
      background: #2c2c46;
      border-color: #555;
      color: var(--dark-text-bot);
    }

    body.dark textarea[type="text"]:focus {
      border-color: #3390ff;
      box-shadow: 0 0 12px #3390ff;
      background: #2c2c46;
      color: var(--dark-text-bot);
    }

    button#sendBtn {
      background: var(--blue);
      border: none;
      color: white;
      font-weight: 600;
      border-radius: 9999px;
      padding: 0 18px;
      cursor: pointer;
      font-size: 16px;
      min-width: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
      user-select: none;
      box-shadow: 0 3px 10px rgba(0, 123, 255, 0.5);
    }

    button#sendBtn:hover {
      background: #0056b3;
    }

    .mic-btn {
      background: var(--red);
      border: none;
      color: white;
      font-weight: 600;
      border-radius: 9999px;
      padding: 0 14px;
      cursor: pointer;
      font-size: 20px;
      min-width: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
      user-select: none;
      box-shadow: 0 3px 10px rgba(220, 53, 69, 0.6);
    }

    .mic-btn.active {
      animation: pulse 1.6s infinite;
      background: #b71c1c;
      box-shadow: 0 0 15px 5px #b71c1c;
    }

    .mic-btn:hover {
      background: #a71b1b;
    }

    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      user-select: none;
    }

    .slider-container {
      display: flex;
      flex-direction: column;
      font-size: 11px;
      color: #666;
      user-select: none;
      width: 70px;
    }

    body.dark .slider-container {
      color: #bbb;
    }

    input[type="range"] {
      width: 100%;
      cursor: pointer;
      margin-top: 4px;
    }

    select {
      border-radius: 6px;
      border: 1.5px solid #ccc;
      padding: 4px 8px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      user-select: none;
      transition: border-color 0.3s ease;
    }

    select:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 6px var(--blue);
    }

    body.dark select {
      background: #2c2c46;
      color: var(--dark-text-bot);
      border-color: #555;
    }

    /* Scrollbar for messages */
    .messages::-webkit-scrollbar {
      width: 8px;
    }
    .messages::-webkit-scrollbar-thumb {
      background-color: rgba(0,0,0,0.1);
      border-radius: 10px;
    }
    body.dark .messages::-webkit-scrollbar-thumb {
      background-color: rgba(255,255,255,0.15);
    }

    /* Tooltip for copied text */
    .copied-tooltip {
      position: absolute;
      background: var(--blue);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      user-select: none;
      z-index: 10;
      top: -30px;
      right: 0;
    }

    .message.copied .copied-tooltip {
      opacity: 1;
    }

    /* Quick reply buttons */
    .quick-replies {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .quick-reply-btn {
      background: var(--blue);
      border: none;
      border-radius: 14px;
      color: white;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 2px 8px rgba(0,123,255,0.6);
      transition: background-color 0.3s ease;
    }

    .quick-reply-btn:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <main class="chat-container" role="main" aria-label="Smart Voice AI Chatbot">

    <header class="header" aria-live="polite" aria-atomic="true">
      <button class="toggle-btn" id="darkModeToggle" aria-pressed="false" aria-label="Toggle dark mode">Dark Mode</button>
      <button id="clearBtn" aria-label="Clear chat history">Clear Chat</button>
      <button id="pauseTTSBtn" aria-label="Pause/Resume speech synthesis">Pause TTS</button>
    </header>

    <section class="messages" id="messages" role="log" aria-live="polite" aria-relevant="additions"></section>

    <form class="form-area" id="chatForm" role="search" aria-label="Chat input form">
      <textarea
        id="chatInput"
        name="chatInput"
        aria-label="Chat message input"
        placeholder="Type your message (Shift+Enter for newline)..."
        rows="1"
        autocomplete="off"
        required
      ></textarea>
      <button type="button" class="mic-btn" id="micBtn" aria-pressed="false" aria-label="Toggle speech recognition (microphone)">
        ðŸŽ¤
      </button>
      <button type="submit" id="sendBtn" aria-label="Send chat message">âž¤</button>
    </form>

    <section class="controls" aria-label="Speech synthesis controls" style="padding: 0 24px 16px;">
      <div class="slider-container">
        <label for="speechRate" id="speechRateLabel">Speech Rate</label>
        <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1" aria-labelledby="speechRateLabel" />
      </div>
      <div class="slider-container">
        <label for="speechPitch" id="speechPitchLabel">Speech Pitch</label>
        <input type="range" id="speechPitch" min="0" max="2" step="0.1" value="1" aria-labelledby="speechPitchLabel" />
      </div>
      <div>
        <label for="voiceSelect">Voice</label>
        <select id="voiceSelect" aria-label="Select voice for speech synthesis"></select>
      </div>
    </section>

    <div id="errorBanner" class="error-banner" role="alert" aria-live="assertive" style="display:none;"></div>
    <div id="successBanner" class="success-banner" role="status" aria-live="polite" style="display:none;"></div>
  </main>

<script>
(() => {
  const messagesEl = document.getElementById('messages');
  const chatInput = document.getElementById('chatInput');
  const chatForm = document.getElementById('chatForm');
  const micBtn = document.getElementById('micBtn');
  const sendBtn = document.getElementById('sendBtn');
  const darkModeToggle = document.getElementById('darkModeToggle');
  const clearBtn = document.getElementById('clearBtn');
  const errorBanner = document.getElementById('errorBanner');
  const successBanner = document.getElementById('successBanner');
  const pauseTTSBtn = document.getElementById('pauseTTSBtn');
  const speechRateSlider = document.getElementById('speechRate');
  const speechPitchSlider = document.getElementById('speechPitch');
  const voiceSelect = document.getElementById('voiceSelect');

  let speechSynthesisUtterance = null;
  let isSpeaking = false;
  let isMicActive = false;
  let recognition = null;
  let voices = [];
  let sessionToken = generateSessionToken();

  // Message history saved as array of {role:'user'|'bot', text:string, timestamp:string}
  let chatHistory = [];

  // Typing indicator variables
  let typingInterval = null;
  let typingDotCount = 0;

  // For last message edit
  let lastUserMessageId = null;

  // Setup SpeechRecognition (webkit prefix fallback)
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = true;
    recognition.lang = 'en-US';
  } else {
    micBtn.disabled = true;
    micBtn.title = 'Speech recognition not supported in this browser.';
  }

  // Initialize voices
  function loadVoices() {
    voices = speechSynthesis.getVoices();
    voiceSelect.innerHTML = '';
    voices.forEach((voice, i) => {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = voice.name + (voice.default ? ' (default)' : '');
      voiceSelect.appendChild(option);
    });
    // Select default voice
    const defaultIndex = voices.findIndex(v => v.default) || 0;
    voiceSelect.value = defaultIndex;
  }
  loadVoices();
  if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = loadVoices;
  }

  // Generate session token to simulate conversation continuity (random UUID)
  function generateSessionToken() {
    return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
  }

  // Save chat to localStorage
  function saveChatHistory() {
    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
  }

  // Load chat from localStorage
  function loadChatHistory() {
    const saved = localStorage.getItem('chatHistory');
    if (saved) {
      try {
        chatHistory = JSON.parse(saved);
        chatHistory.forEach(({role, text, timestamp}) => {
          addMessage(role, text, timestamp, false);
        });
        scrollToBottom();
      } catch {
        chatHistory = [];
      }
    }
  }

  // Add message to chat window
  function addMessage(role, text, timestamp = null, save = true, quickReplies = []) {
    const message = document.createElement('div');
    message.classList.add('message');
    message.classList.add(role);
    const time = timestamp || new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    message.setAttribute('data-timestamp', time);
    message.tabIndex = 0; // focusable for accessibility
    message.textContent = text;

    // Tooltip for copy
    const tooltip = document.createElement('span');
    tooltip.className = 'copied-tooltip';
    tooltip.textContent = 'Copied!';
    message.appendChild(tooltip);

    // Copy text on click
    message.addEventListener('click', () => {
      navigator.clipboard.writeText(text).then(() => {
        message.classList.add('copied');
        setTimeout(() => message.classList.remove('copied'), 1500);
      });
    });

    // Quick replies if any
    if (quickReplies.length > 0) {
      const quickRepliesContainer = document.createElement('div');
      quickRepliesContainer.className = 'quick-replies';
      quickReplies.forEach(qr => {
        const btn = document.createElement('button');
        btn.className = 'quick-reply-btn';
        btn.textContent = qr;
        btn.type = 'button';
        btn.addEventListener('click', () => {
          chatInput.value = qr;
          chatInput.focus();
        });
        quickRepliesContainer.appendChild(btn);
      });
      message.appendChild(quickRepliesContainer);
    }

    messagesEl.appendChild(message);
    if (save) {
      chatHistory.push({role, text, timestamp: time});
      saveChatHistory();
    }
  }

  // Show typing indicator
  function showTyping() {
    if (!document.querySelector('.typing')) {
      const typingMessage = document.createElement('div');
      typingMessage.className = 'message bot typing';
      typingMessage.textContent = 'Smart Voice AI Chatbot is typing';
      messagesEl.appendChild(typingMessage);
      scrollToBottom();

      typingInterval = setInterval(() => {
        typingDotCount = (typingDotCount + 1) % 4;
        typingMessage.textContent = 'Smart Voice AI Chatbot is typing' + '.'.repeat(typingDotCount);
        scrollToBottom();
      }, 500);
    }
  }

  // Remove typing indicator
  function removeTyping() {
    const typingMessage = document.querySelector('.typing');
    if (typingMessage) {
      typingMessage.remove();
      clearInterval(typingInterval);
      typingInterval = null;
      typingDotCount = 0;
    }
  }

  // Scroll chat to bottom
  function scrollToBottom() {
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // Handle sending user input
  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const userText = chatInput.value.trim();
    if (!userText) return;
    addMessage('user', userText);
    chatInput.value = '';
    removeTyping();
    showTyping();

    // Simulate bot response delay and generate response
    try {
      const responseText = await generateBotResponse(userText);
      removeTyping();
      addMessage('bot', responseText, null, true, ['Tell me more', 'Explain', 'Summarize']);
      scrollToBottom();
      speakText(responseText);
    } catch (err) {
      removeTyping();
      addMessage('bot', 'Sorry, there was an error generating the response.');
    }
  });

  // Microphone toggle
  micBtn.addEventListener('click', () => {
    if (!recognition) return;
    if (isMicActive) {
      recognition.stop();
    } else {
      recognition.start();
    }
  });

  // SpeechRecognition event handlers
  if (recognition) {
    recognition.onstart = () => {
      isMicActive = true;
      micBtn.classList.add('active');
      micBtn.setAttribute('aria-pressed', 'true');
    };
    recognition.onend = () => {
      isMicActive = false;
      micBtn.classList.remove('active');
      micBtn.setAttribute('aria-pressed', 'false');
    };
    recognition.onerror = (event) => {
      console.error('Speech recognition error:', event.error);
      micBtn.classList.remove('active');
      micBtn.setAttribute('aria-pressed', 'false');
    };
    recognition.onresult = (event) => {
      let interimTranscript = '';
      for (let i = event.resultIndex; i < event.results.length; ++i) {
        if (event.results[i].isFinal) {
          chatInput.value = event.results[i][0].transcript.trim();
          chatInput.focus();
        } else {
          interimTranscript += event.results[i][0].transcript;
        }
      }
    };
  }

  // Text-to-Speech synthesis
  function speakText(text) {
    if (isSpeaking) {
      speechSynthesis.cancel();
    }
    speechSynthesisUtterance = new SpeechSynthesisUtterance(text);
    speechSynthesisUtterance.voice = voices[voiceSelect.value] || null;
    speechSynthesisUtterance.rate = parseFloat(speechRateSlider.value);
    speechSynthesisUtterance.pitch = parseFloat(speechPitchSlider.value);
    speechSynthesis.speak(speechSynthesisUtterance);
    isSpeaking = true;
    speechSynthesisUtterance.onend = () => {
      isSpeaking = false;
    };
  }

  // Pause/Resume TTS
  pauseTTSBtn.addEventListener('click', () => {
    if (!speechSynthesisUtterance) return;
    if (speechSynthesis.speaking) {
      speechSynthesis.pause();
      pauseTTSBtn.textContent = 'Resume TTS';
    } else if (speechSynthesis.paused) {
      speechSynthesis.resume();
      pauseTTSBtn.textContent = 'Pause TTS';
    }
  });

  // Dark mode toggle
  darkModeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark');
    const isDark = document.body.classList.contains('dark');
    darkModeToggle.setAttribute('aria-pressed', isDark ? 'true' : 'false');
  });

  // Clear chat
  clearBtn.addEventListener('click', () => {
    chatHistory = [];
    saveChatHistory();
    messagesEl.innerHTML = '';
  });

  // Scroll to bottom on new messages
  messagesEl.addEventListener('DOMNodeInserted', () => {
    scrollToBottom();
  });

  // Load previous chat history on page load
  loadChatHistory();

  // Dummy bot response generator (to be replaced with actual backend call)
  async function generateBotResponse(userText) {
    // For demo, just echo with some twist
    return new Promise((resolve) => {
      setTimeout(() => {
        resolve(`You said: "${userText}". What's next?`);
      }, 900);
    });
  }

})();
</script>
</body>
</html>
